<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“èª¿ãƒ¢ãƒ‹ã‚¿ãƒ¼ - æç«œè‚²æˆ</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ä½“èª¿ãƒ¢ãƒ‹ã‚¿ãƒ¼">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <meta name="description" content="æ¯æ—¥ã®ä½“èª¿ã‚’è¨˜éŒ²ã—ã¦æç«œã‚’è‚²ã¦ã‚ˆã†">

    <!-- Common Modules -->
    <script src="js/date-utils.js"></script>
    <script src="js/storage-utils.js"></script>
    <script src="dinosaur-species.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/unlock-system.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
        }

        .emoji-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .emoji-btn {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 2rem;
            min-width: 100px;
            text-align: center;
        }

        .emoji-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .number-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin: 2rem 0;
        }

        .number-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .number-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .result {
            text-align: center;
            padding: 2rem;
            background: #f0fdf4;
            border-radius: 12px;
            margin-top: 2rem;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result h2 {
            color: #10b981;
            margin: 0 0 1rem 0;
        }

        .history {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .history-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
        }

        .back-btn {
            background: #94a3b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .back-btn:hover {
            background: #64748b;
        }

        .hidden {
            display: none;
        }

        .data-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .export-btn,
        .import-btn {
            flex: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .export-btn:hover,
        .import-btn:hover {
            background: #f0f4ff;
        }

        #fileInput {
            display: none;
        }

        .character-display {
            position: relative;
            /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®åŸºæº–ç‚¹ */
            text-align: center;
            padding: 2rem 1rem;
            margin: 1rem 0;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border-radius: 16px;
        }

        .character-emoji {
            width: 220px;
            height: 220px;
            display: block;
            margin: 0 auto 0.5rem;
            image-rendering: pixelated;
            object-fit: contain;
            background: transparent;
            animation: bounce 2s ease-in-out infinite;
            transition: transform 0.3s ease;
            /* ç”»åƒã‚’ä¸­å¤®ã«é…ç½®ã—ã€ã‚µã‚¤ã‚ºã‚’çµ±ä¸€ */
            object-position: center;
            cursor: pointer;
            /* ã‚¿ãƒƒãƒ—å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
            user-select: none;
            /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’é˜²æ­¢ */
        }

        .character-emoji.growing {
            animation: grow 1s ease-in-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes grow {
            0% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.5) rotate(-10deg);
            }

            50% {
                transform: scale(1.2) rotate(10deg);
            }

            75% {
                transform: scale(1.5) rotate(-10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        /* ã‚¿ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes hop {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-40px) scale(1.15);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes wiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(-15deg);
            }

            60% {
                transform: rotate(15deg);
            }
        }

        .character-emoji.hop {
            animation: hop 0.6s ease !important;
        }

        .character-emoji.spin {
            animation: spin 0.8s ease !important;
        }

        .character-emoji.wiggle {
            animation: wiggle 0.5s ease !important;
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 2rem;
            z-index: 100;
            animation: fly-up 1.5s ease-out forwards;
        }

        @keyframes fly-up {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0);
            }

            50% {
                transform: translateY(-60px) scale(1.3);
            }

            100% {
                opacity: 0;
                transform: translateY(-120px) scale(0.6);
            }
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .character-stats {
            font-size: 0.9rem;
            color: #64748b;
        }

        .next-stage {
            font-size: 0.85rem;
            color: #10b981;
            margin-top: 0.5rem;
        }

        .selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .selection-modal.show {
            display: flex;
        }

        .selection-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            text-align: center;
        }

        .selection-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .dino-options {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            /* æŠ˜ã‚Šè¿”ã— */
            justify-content: center;
            /* ä¸­å¤®å¯„ã› */
            max-height: 50vh;
            /* ç”»é¢ã®åŠåˆ†ç¨‹åº¦ã®é«˜ã•ã«åˆ¶é™ */
            overflow-y: auto;
            /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
            padding: 10px;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨ã®ä½™ç™½ */
        }

        .dino-card {
            flex: 1;
            padding: 1.5rem;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dino-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .dino-card img {
            width: 120px;
            height: 120px;
            display: block;
            margin: 0 auto 0.5rem;
            image-rendering: pixelated;
            object-fit: contain;
            background: transparent;
            /* ç”»åƒã‚’ä¸­å¤®ã«é…ç½®ã—ã€ã‚µã‚¤ã‚ºã‚’çµ±ä¸€ */
            object-position: center;
        }

        .dino-name {
            font-weight: 600;
            color: #1e293b;
        }

        .memo-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        .memo-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-primary {
            flex: 1;
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            flex: 1;
            background: #e2e8f0;
            color: #64748b;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .settings-btn {
            background: #e2e8f0;
            color: #64748b;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 0.5rem;
            font-size: 1.2rem;
        }

        .settings-btn:hover {
            background: #cbd5e1;
        }

        .backup-area {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: left;
        }

        .backup-desc {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .backup-textarea {
            width: 100%;
            height: 100px;
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 0.5rem;
        }

        .copy-btn {
            background: #3b82f6;
            color: white;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .restore-btn {
            background: #ef4444;
            color: white;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="container">
            <header class="app-header">
                <h1 style="margin: 0; font-size: 1.5rem;">ğŸ¦• ä½“èª¿ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
                <div class="header-buttons">
                    <a href="history-calendar.html" class="icon-link" aria-label="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼">ğŸ“…</a>
                    <a href="encyclopedia.html" class="icon-link" aria-label="å›³é‘‘">ğŸ“š</a>
                    <button class="settings-btn" onclick="openSettings()" aria-label="è¨­å®š">âš™ï¸</button>
                </div>
            </header>

            <style>
                .app-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 2rem;
                }

                .header-buttons {
                    display: flex;
                    gap: 0.5rem;
                }

                .icon-link {
                    background: #f1f5f9;
                    color: #1e293b;
                    width: 44px;
                    height: 44px;
                    border-radius: 12px;
                    text-decoration: none;
                    font-size: 1.5rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border: 2px solid #e2e8f0;
                    transition: transform 0.1s;
                }

                .icon-link:active {
                    transform: scale(0.95);
                }

                .settings-btn {
                    background: #f1f5f9;
                    color: #1e293b;
                    width: 44px;
                    height: 44px;
                    padding: 0;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    font-size: 1.5rem;
                    margin-left: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
                .selection-content {
                    width: 90% !important;
                    max-width: 400px !important;
                    padding: 1.5rem !important;
                    max-height: 85vh;
                    overflow-y: auto;
                }

                /* ã‚¹ãƒãƒ›ç”¨èª¿æ•´ */
                @media (max-width: 480px) {
                    .container {
                        padding: 1rem;
                    }

                    .app-header {
                        flex-direction: row;
                        /* æ¨ªä¸¦ã³ç¶­æŒï¼ˆã‚¢ã‚¤ã‚³ãƒ³åŒ–ã—ãŸã®ã§åã¾ã‚‹ã¯ãšï¼‰ */
                        margin-bottom: 1.5rem;
                    }

                    h1 {
                        font-size: 1.2rem !important;
                    }
                }

                /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                .nickname-container {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    margin-bottom: 0.5rem;
                }

                .edit-nickname-btn {
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 1rem;
                    opacity: 0.6;
                    transition: opacity 0.2s;
                    padding: 4px;
                }

                .edit-nickname-btn:hover {
                    opacity: 1;
                }

                /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
                .nickname-modal-content {
                    background: white;
                    padding: 2rem;
                    border-radius: 20px;
                    width: 90%;
                    max-width: 400px;
                    text-align: center;
                    position: relative;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                }

                .nickname-input-group {
                    display: flex;
                    gap: 8px;
                    margin: 1.5rem 0;
                }

                .nickname-input {
                    flex: 1;
                    padding: 12px;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    font-size: 1rem;
                    outline: none;
                    transition: border-color 0.3s;
                }

                .nickname-input:focus {
                    border-color: #667eea;
                }

                .random-name-btn {
                    background: #f1f5f9;
                    border: none;
                    border-radius: 12px;
                    width: 48px;
                    cursor: pointer;
                    font-size: 1.2rem;
                    transition: background 0.2s;
                }

                .random-name-btn:hover {
                    background: #e2e8f0;
                }

                .modal-buttons {
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                }

                /* å±¥æ­´ãƒªã‚¹ãƒˆå†…ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  */
                .history-nickname {
                    font-weight: bold;
                    color: #4b5563;
                    margin-right: 0.5rem;
                }

                /* é€±é–“ã‚µãƒãƒªãƒ¼ */
                .weekly-summary {
                    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                    border-radius: 16px;
                    padding: 1.5rem;
                    margin: 1rem 0;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                }

                .weekly-summary h3 {
                    margin: 0 0 1rem 0;
                    color: #92400e;
                    font-size: 1.1rem;
                }

                .summary-stats {
                    display: flex;
                    justify-content: space-around;
                    margin-bottom: 1rem;
                }

                .stat-item {
                    text-align: center;
                }

                .stat-label {
                    display: block;
                    font-size: 0.8rem;
                    color: #78716c;
                }

                .stat-value {
                    display: block;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #1e293b;
                }

                .weekly-chart {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-end;
                    height: 80px;
                    margin: 1rem 0;
                    padding: 0 0.5rem;
                }

                .chart-bar {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    width: 12%;
                }

                .bar-fill {
                    width: 100%;
                    max-width: 24px;
                    background: linear-gradient(to top, #f59e0b, #fbbf24);
                    border-radius: 4px 4px 0 0;
                    transition: height 0.3s ease;
                }

                .bar-empty {
                    background: #e5e7eb;
                }

                .bar-label {
                    font-size: 0.7rem;
                    color: #78716c;
                    margin-top: 4px;
                }

                .bar-value {
                    font-size: 0.75rem;
                    font-weight: bold;
                    color: #1e293b;
                    margin-bottom: 2px;
                }

                .weekly-comment {
                    text-align: center;
                    font-size: 0.9rem;
                    color: #57534e;
                    margin: 0.5rem 0 0 0;
                    padding-top: 0.5rem;
                    border-top: 1px dashed #d6d3d1;
                }
            </style>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—1 -->
            <div id="step1">
                <p style="text-align: center; color: #64748b;">ä»Šæ—¥ã®ä½“èª¿ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</p>
                <div class="emoji-buttons">
                    <button class="emoji-btn" onclick="selectRange('good')">
                        <div>ğŸ˜Š</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">è‰¯ã„</div>
                    </button>
                    <button class="emoji-btn" onclick="selectRange('normal')">
                        <div>ğŸ˜</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">æ™®é€š</div>
                    </button>
                    <button class="emoji-btn" onclick="selectRange('bad')">
                        <div>ğŸ˜</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">æ‚ªã„</div>
                    </button>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2 -->
            <div id="step2" class="hidden">
                <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
                <p style="text-align: center; color: #64748b;">å…·ä½“çš„ã«ã¯ï¼Ÿ</p>
                <div class="number-buttons" id="numberButtons"></div>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¡ãƒ¢å…¥åŠ› -->
            <div id="step3" class="hidden">
                <button class="back-btn" onclick="goBackToStep2()">â† æˆ»ã‚‹</button>
                <p style="text-align: center; color: #64748b; margin-bottom: 1rem;">ä¸€è¨€ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</p>
                <textarea id="memoInput" class="memo-input" placeholder="ä»Šæ—¥ã®ä½“èª¿ã«ã¤ã„ã¦ä¸€è¨€...ï¼ˆä¾‹: ã‚ˆãçœ ã‚ŒãŸã€é ­ç—›ãŒã™ã‚‹ã€ãªã©ï¼‰"
                    maxlength="100"></textarea>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="skipMemo()">ã‚¹ã‚­ãƒƒãƒ—</button>
                    <button class="btn-primary" onclick="saveMemo()">è¨˜éŒ²ã™ã‚‹</button>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º -->
            <div class="character-display" id="characterDisplay">
                <img src="assets/characters/trex_egg.png" alt="ã‚¿ãƒã‚´" class="character-emoji" id="characterEmoji"
                    onclick="onCharacterTap()">
                <div class="nickname-container">
                    <div class="character-name" id="characterName">ã‚¿ãƒã‚´</div>
                    <button class="edit-nickname-btn" onclick="openNicknameModal()" title="åå‰ã‚’å¤‰æ›´">âœ</button>
                </div>
                <div class="character-stats" id="characterStats">é€£ç¶šè¨˜éŒ²: 0æ—¥</div>
                <div class="next-stage" id="nextStage">è¨˜éŒ²ã™ã‚‹ã¨å­µåŒ–ã—ã¾ã™ï¼</div>
            </div>

            <!-- çµæœ -->
            <div id="result" class="result">
                <h2>âœ… è¨˜éŒ²å®Œäº†ï¼</h2>
                <p>ä½“èª¿å€¤: <span id="recordedValue">-</span></p>
                <p id="encouragement">ç´ æ™´ã‚‰ã—ã„ï¼</p>
            </div>

            <!-- é€±é–“ã‚µãƒãƒªãƒ¼ -->
            <div class="weekly-summary" id="weeklySummary">
                <h3>ğŸ“… ä»Šé€±ã®ã¾ã¨ã‚</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</span>
                        <span class="stat-value" id="weeklyAvg">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">é”æˆç‡</span>
                        <span class="stat-value" id="weeklyRate">--%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æœ€é«˜</span>
                        <span class="stat-value" id="weeklyMax">--</span>
                    </div>
                </div>
                <div class="weekly-chart" id="weeklyChart"></div>
                <p class="weekly-comment" id="weeklyComment">ğŸ¦• ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>

            <!-- å±¥æ­´ -->
            <div class="history">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <h3>ğŸ“Š æœ€è¿‘ã®è¨˜éŒ² (<span id="recordCount">0</span>ä»¶)</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="graph.html"
                            style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-size: 0.9rem;">ğŸ“ˆ
                            ã‚°ãƒ©ãƒ•è¡¨ç¤º</a>
                        <button onclick="openNicknameModal()"
                            style="background: #8b5cf6; color: white; padding: 0.5rem 1rem; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem;">ğŸ·ï¸
                            åå‰å¤‰æ›´</button>
                    </div>
                </div>
                <div class="data-controls">
                    <button class="export-btn" onclick="exportData()">â¬‡ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="import-btn" onclick="document.getElementById('fileInput').click()">â¬†ï¸
                        ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
                </div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- æç«œé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="selection-modal" id="selectionModal">
            <div class="selection-content">
                <h2 class="selection-title">ğŸ¦– ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã¶</h2>
                <p style="color: #64748b;">ä¸€ç·’ã«æˆé•·ã™ã‚‹æç«œã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="dino-options" id="dinoSelectionGrid">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="selection-modal" id="nicknameModal">
            <div class="nickname-modal-content">
                <h2 style="margin-bottom: 0.5rem;">ğŸ·ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</h2>
                <p style="color: #64748b; font-size: 0.9rem;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«åå‰ã‚’ã¤ã‘ã‚ˆã†</p>

                <div class="nickname-input-group">
                    <input type="text" id="nicknameInput" class="nickname-input" placeholder="åå‰ã‚’å…¥åŠ›..." maxlength="10">
                    <button class="random-name-btn" onclick="suggestRandomName()" title="ãƒ©ãƒ³ãƒ€ãƒ ææ¡ˆ">ğŸ²</button>
                </div>

                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeNicknameModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn-primary" onclick="saveNickname()">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="selection-modal" id="settingsModal">
            <div class="selection-content" style="max-width: 600px;">
                <h2 class="selection-title">âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <p style="color: #64748b; margin-bottom: 1.5rem; text-align: center;">ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã§ãã¾ã™</p>

                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ’¾</span>
                        <h3 class="section-title">ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                    </div>
                    <p class="section-desc">
                        ç¾åœ¨ã®ä½“èª¿è¨˜éŒ²ã¨æç«œã®è‚²æˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™ã€‚
                    </p>
                    <textarea id="exportText" class="backup-textarea" readonly
                        placeholder="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                    <button class="action-btn backup-btn" onclick="exportBackup()">
                        <span>ğŸ“‹</span> ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                </div>

                <!-- å¾©å…ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">â™»ï¸</span>
                        <h3 class="section-title">ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ</h3>
                    </div>
                    <p class="section-desc">
                        ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã§ãã¾ã™ã€‚
                    </p>
                    <textarea id="importText" class="backup-textarea" placeholder="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                    <button class="action-btn restore-btn" onclick="importBackup()">
                        <span>âš¡</span> ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                    </button>
                </div>

                <!-- é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="settings-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ””</span>
                        <h3 class="section-title">é€šçŸ¥ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h3>
                    </div>
                    <p class="section-desc">
                        æ¯æœ 7:30 ã«è¨˜éŒ²å¿˜ã‚Œé˜²æ­¢ã®é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
                        <small style="color: #94a3b8;">â€»ã‚¢ãƒ—ãƒªã‚’å®Œå…¨ã«çµ‚äº†ã•ã›ã¦ã„ã‚‹ã¨é€šçŸ¥ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™</small>
                    </p>
                    <button id="notifyBtn" class="action-btn notify-btn" onclick="toggleNotification()">
                        <span>ğŸ””</span> é€šçŸ¥è¨­å®šã‚’ONã«ã™ã‚‹
                    </button>
                </div>

                <button class="btn-secondary" style="width: 100%; margin-top: 1rem;"
                    onclick="closeSettings()">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <style>
            .settings-section {
                background: #f8fafc;
                border: 2px solid #e2e8f0;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1rem;
            }

            .section-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .section-icon {
                font-size: 1.5rem;
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .section-title {
                font-size: 1.1rem;
                font-weight: 700;
                color: #1e293b;
                margin: 0;
            }

            .section-desc {
                font-size: 0.9rem;
                color: #64748b;
                margin-bottom: 1rem;
                line-height: 1.6;
            }

            .action-btn {
                width: 100%;
                padding: 0.875rem 1.5rem;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .action-btn:active {
                transform: translateY(0);
            }

            .backup-btn {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
            }

            .backup-btn:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            }

            .restore-btn {
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: white;
            }

            .restore-btn:hover {
                background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            }

            .notify-btn {
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                color: white;
            }

            .notify-btn:hover {
                background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            }

            .backup-textarea {
                width: 100%;
                min-height: 100px;
                padding: 0.75rem;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-family: 'Courier New', monospace;
                font-size: 0.85rem;
                resize: vertical;
                margin-bottom: 0.75rem;
                background: white;
                transition: border-color 0.2s;
            }

            .backup-textarea:focus {
                outline: none;
                border-color: #667eea;
            }

            .backup-textarea::placeholder {
                color: #cbd5e1;
            }
        </style>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼ˆå…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼‰
        let records = getHealthRecords();
        let growthData = getGrowthData();

        // æç«œãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆç°¡æ˜“ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚° - DINOSAUR_SPECIESã‚’ãƒ™ãƒ¼ã‚¹ã«ä½œæˆï¼‰
        const dinosaurs = {};
        if (typeof DINOSAUR_SPECIES !== 'undefined') {
            for (const [id, species] of Object.entries(DINOSAUR_SPECIES)) {
                dinosaurs[id] = {
                    name: species.name,
                    scale: 1.2,
                    stages: {
                        0: { image: species.stages[0].image, name: species.stages[0].name },
                        1: { image: species.stages[1].image, name: species.stages[1].name },
                        2: { image: species.stages[2].image, name: species.stages[2].name },
                        3: { image: species.stages[3].image, name: species.stages[3].name }
                    }
                };
            }
        }

        // æˆé•·ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        if (!growthData) {
            growthData = {
                selectedDinosaur: null,
                consecutiveDays: 0,
                lastRecordDate: null,
                selectionDate: null,
                currentStage: 0
            };
            saveGrowthData(growthData);
        }

        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
        initializeUnlockedSpecies();

        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        window.addEventListener('load', () => {
            renderDinoSelection(); // é¸æŠç”»é¢ç”Ÿæˆ
            checkCycleReset(); // 30æ—¥ã‚µã‚¤ã‚¯ãƒ«ãƒã‚§ãƒƒã‚¯

            if (!growthData.selectedDinosaur) {
                document.getElementById('selectionModal').classList.add('show');
            } else {
                updateCharacterDisplay();
            }
        });

        // æˆé•·æ®µéšå–å¾—
        function getStage(days) {
            const dino = dinosaurs[growthData.selectedDinosaur];
            let stageLevel = 0;
            let next = 1;

            if (days >= 22) { stageLevel = 3; next = null; }
            else if (days >= 8) { stageLevel = 2; next = 22 - days; }
            else if (days >= 1) { stageLevel = 1; next = 8 - days; }

            return {
                stage: stageLevel,
                image: dino.stages[stageLevel].image, // ãƒ‘ã‚¹ã¯dinosaur-species.jsã«æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹
                name: dino.stages[stageLevel].name,
                next: next
            };
        }



        // 30æ—¥ã‚µã‚¤ã‚¯ãƒ«ãƒªã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        function checkCycleReset() {
            const today = getTodayString();

            // ç§»è¡Œæªç½®: selectionDateãŒãªãã€selectedDinosaurãŒã„ã‚‹å ´åˆ
            if (growthData.selectedDinosaur && !growthData.selectionDate) {
                let newStartDate = today;

                if (growthData.selectionMonth) {
                    const monthPrefix = growthData.selectionMonth;
                    const sortedRecords = records.filter(r => r.date.startsWith(monthPrefix)).sort((a, b) => a.date.localeCompare(b.date));

                    if (sortedRecords.length > 0) {
                        newStartDate = sortedRecords[0].date;
                    } else {
                        if (monthPrefix === today.slice(0, 7)) {
                            newStartDate = today;
                        } else {
                            newStartDate = `${monthPrefix}-01`;
                        }
                    }
                }

                growthData.selectionDate = newStartDate;
                saveGrowthData(growthData);
            }

            // ãƒªã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
            if (shouldResetCycle(growthData, today)) {
                alert('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®æ—…ã‹ã‚‰30æ—¥ãŒçµŒéã—ã¾ã—ãŸï¼\\næ–°ã—ã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');

                // å›³é‘‘ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
                completeCurrentCycle(growthData);

                // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                growthData = createInitialGrowthData(null);
                growthData.selectedDinosaur = null; // é¸æŠãªã—ã«æˆ»ã™
                saveGrowthData(growthData);

                document.getElementById('selectionModal').classList.add('show');
            }
        }

        // æç«œé¸æŠ
        function selectDinosaur(type) {
            growthData = createInitialGrowthData(type);
            saveGrowthData(growthData);

            document.getElementById('selectionModal').classList.remove('show');
            updateCharacterDisplay();
        }

        // æç«œé¸æŠç”»é¢ã®å‹•çš„ç”Ÿæˆï¼ˆã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®ã¿è¡¨ç¤ºï¼‰
        function renderDinoSelection() {
            const grid = document.getElementById('dinoSelectionGrid');
            grid.innerHTML = '';

            // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿æç«œã®ã¿å–å¾—
            const selectable = getSelectableSpecies();

            selectable.forEach(species => {
                const key = species.id;
                const dino = dinosaurs[key];
                if (!dino) return; // ãƒãƒƒãƒ”ãƒ³ã‚°ã«ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                const card = document.createElement('div');
                card.className = 'dino-card';
                card.onclick = () => selectDinosaur(key);

                // scaleé©ç”¨
                const scale = dino.scale || 1.0;

                card.innerHTML = `
                    <img src="${dino.stages[0].image}" alt="${dino.name}" style="transform: scale(${scale})">
                    <div class="dino-name">${dino.name}</div>
                `;
                grid.appendChild(card);
            });
        }

        // å›³é‘‘æ›´æ–°ï¼ˆå…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
        function updateEncyclopedia(dinosaur, stage) {
            updateEncyclopediaEntry(dinosaur, stage);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateCharacterDisplay(isGrowing = false) {
            const stageInfo = getStage(growthData.selectedDinosaur ? growthData.consecutiveDays : 0); // selectedDinosaurãŒnullã®å ´åˆã¯0æ—¥ã¨ã—ã¦æ‰±ã†
            const img = document.getElementById('characterEmoji');

            if (isGrowing) {
                img.classList.add('growing');
                setTimeout(() => img.classList.remove('growing'), 1000);
            }

            img.src = stageInfo.image;
            img.alt = stageInfo.name;

            // åå‰æ›´æ–°ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ç¨®æ—åã®ã¿ï¼‰
            const speciesName = DINOSAUR_SPECIES[growthData.selectedDinosaur].name;
            let displayName;

            if (growthData.nickname) {
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆ: "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (ç¨®æ—å) (Lv.X)"
                displayName = `${growthData.nickname} (${speciesName}) (Lv.${stageInfo.stage})`;
            } else {
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒãªã„å ´åˆ: "ç¨®æ—å (Lv.X)"
                displayName = `${speciesName} (Lv.${stageInfo.stage})`;
            }

            document.getElementById('characterName').textContent = displayName;

            // ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
            const dino = dinosaurs[growthData.selectedDinosaur];
            if (dino && dino.scale) {
                img.style.transform = `scale(${dino.scale})`;
            } else {
                img.style.transform = 'scale(1)';
            }

            document.getElementById('characterStats').textContent = `é€£ç¶šè¨˜éŒ²: ${growthData.consecutiveDays}æ—¥`;

            // æˆé•·æ®µéšã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (stageInfo.next !== null) {
                let message;
                if (stageInfo.stage === 0) {
                    // ã‚¿ãƒã‚´æ®µéš
                    message = 'è¨˜éŒ²ã™ã‚‹ã¨å­µåŒ–ã—ã¾ã™ï¼';
                } else {
                    // èµ¤ã¡ã‚ƒã‚“ã€å­ä¾›æ®µéš
                    message = `ã‚ã¨${stageInfo.next}æ—¥ã§æˆé•·ï¼`;
                }
                document.getElementById('nextStage').textContent = message;
            } else {
                document.getElementById('nextStage').textContent = 'æœ€å¤§ãƒ¬ãƒ™ãƒ«é”æˆï¼';
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¿ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        function onCharacterTap() {
            if (!growthData.selectedDinosaur) return; // æç«œãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

            const img = document.getElementById('characterEmoji');
            const container = document.querySelector('.character-display');
            const stage = getStage(growthData.consecutiveDays).stage;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠï¼ˆæˆé•·æ®µéšåˆ¥ï¼‰
            const animations = getAnimationsForStage(stage);
            const randomAnim = animations[Math.floor(Math.random() * animations.length)];

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
            img.classList.add(randomAnim);
            setTimeout(() => img.classList.remove(randomAnim), 1000);

            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            createParticleEffect(container, stage);
        }

        // æˆé•·æ®µéšã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        function getAnimationsForStage(stage) {
            switch (stage) {
                case 0: return ['wiggle']; // ã‚¿ãƒã‚´
                case 1: return ['hop', 'wiggle']; // èµ¤ã¡ã‚ƒã‚“
                case 2: return ['hop', 'spin']; // å­ä¾›
                case 3: return ['hop', 'spin']; // å¤§äºº
                default: return ['hop'];
            }
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆ
        function createParticleEffect(container, stage) {
            // æˆé•·æ®µéšã«å¿œã˜ãŸçµµæ–‡å­—
            const emojis = {
                0: ['âœ¨', 'ğŸ’«'], // ã‚¿ãƒã‚´
                1: ['â¤ï¸', 'ğŸ’•'], // èµ¤ã¡ã‚ƒã‚“
                2: ['â­', 'ğŸŒŸ'], // å­ä¾›
                3: ['â¤ï¸', 'â­', 'ğŸ’–', 'âœ¨'] // å¤§äºº
            };

            const particles = emojis[stage] || ['â¤ï¸'];
            const particleCount = stage === 3 ? 6 : 4; // å¤§äººã¯å¤šã‚

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];

                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ï¼ˆä¸­å¿ƒã‹ã‚‰åºƒãŒã‚‹ã‚ˆã†ã«ï¼‰
                const angle = (Math.PI * 2 * i) / particleCount + (Math.random() - 0.5);
                const distance = 30 + Math.random() * 30;
                particle.style.left = `calc(50% + ${Math.cos(angle) * distance}px)`;
                particle.style.top = `calc(50% + ${Math.sin(angle) * distance}px)`;

                container.appendChild(particle);

                // 1.5ç§’å¾Œã«å‰Šé™¤
                setTimeout(() => particle.remove(), 1500);
            }
        }

        function selectRange(range) {
            const numbers = range === 'good' ? [8, 9, 10] :
                range === 'normal' ? [4, 5, 6, 7] : [1, 2, 3];

            const container = document.getElementById('numberButtons');
            container.innerHTML = '';

            numbers.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = num;
                btn.onclick = () => showMemoStep(num);
                container.appendChild(btn);
            });

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        let selectedValue = null;

        function showMemoStep(value) {
            selectedValue = value;
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('memoInput').value = '';
            document.getElementById('memoInput').focus();
        }

        function goBackToStep2() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function skipMemo() {
            recordValue(selectedValue, '');
        }

        function saveMemo() {
            const memo = document.getElementById('memoInput').value.trim();
            recordValue(selectedValue, memo);
        }

        function goBack() {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('result').classList.remove('show');
        }

        function recordValue(value, memo = '') {
            const today = getTodayString();
            const time = new Date().toLocaleTimeString('ja-JP');

            // æ—¢å­˜ã®åŒæ—¥è¨˜éŒ²ã‚’æ¢ã™
            const existingIndex = records.findIndex(r => r.date === today);

            const record = {
                date: today,
                time: time,
                value: value,
                memo: memo,
                timestamp: Date.now()
            };

            // æˆé•·ã‚·ã‚¹ãƒ†ãƒ ç”¨å¤‰æ•°
            const isNewRecord = existingIndex === -1;
            let didGrow = false;

            if (existingIndex !== -1) {
                // æ—¢å­˜ã®è¨˜éŒ²ã‚’æ›´æ–°
                records[existingIndex] = record;
            } else {
                // æ–°è¦è¿½åŠ 
                records.push(record);
            }

            saveHealthRecords(records);

            let encouragementMsg = value >= 8 ? 'ç´ æ™´ã‚‰ã—ã„èª¿å­ã§ã™ï¼' :
                value >= 4 ? 'å®‰å®šã—ã¦ã„ã¾ã™ã­ã€‚' : 'ç„¡ç†ã›ãšä¼‘ã‚“ã§ãã ã•ã„ã€‚';

            // æˆé•·å‡¦ç†
            if (isNewRecord && growthData.selectedDinosaur) {
                const updateResult = updateGrowthData(growthData, today);
                growthData = updateResult.data;
                didGrow = updateResult.didGrow;

                // å›³é‘‘æ›´æ–°ï¼ˆæˆé•·æ™‚ï¼‰
                if (didGrow) {
                    updateEncyclopediaEntry(growthData.selectedDinosaur, updateResult.newStage);
                }
                saveGrowthData(growthData);

                // è¡¨ç¤ºã‚’å³æ™‚æ›´æ–°
                updateCharacterDisplay(didGrow);

                // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
                checkAndNotifyUnlocks(records);
            }

            if (isNewRecord && didGrow) {
                const growthInfo = getGrowthInfo(growthData.selectedDinosaur, growthData.consecutiveDays);
                encouragementMsg = `ğŸ‰ ãŠã‚ã§ã¨ã†ï¼${growthInfo.stageName}ã«æˆé•·ã—ã¾ã—ãŸï¼`;
            }

            document.getElementById('recordedValue').textContent = value;
            document.getElementById('encouragement').textContent = encouragementMsg;

            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('result').classList.add('show');

            updateHistory();
            updateWeeklySummary();
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            const sorted = [...records].reverse().slice(0, 10);

            document.getElementById('recordCount').textContent = records.length;

            if (sorted.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #94a3b8;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            historyList.innerHTML = sorted.map(r => `
                <div class="history-item">
                    <span>${r.date} ${r.time}</span>
                    <strong style="color: #667eea;">ä½“èª¿å€¤: ${r.value}</strong>
                </div>
            `).join('');
        }

        // ========== é€±é–“ã‚µãƒãƒªãƒ¼æ©Ÿèƒ½ ==========

        function getLastWeekRecords() {
            const today = new Date();
            const weekData = [];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const record = records.find(r => r.date === dateStr);

                weekData.push({
                    date: dateStr,
                    dayName: dayNames[date.getDay()],
                    value: record ? record.value : null,
                    isToday: i === 0
                });
            }

            return weekData;
        }

        function calculateWeeklyStats(weekData) {
            const validRecords = weekData.filter(d => d.value !== null);

            if (validRecords.length === 0) {
                return { avg: null, max: null, min: null, rate: 0 };
            }

            const values = validRecords.map(d => d.value);
            const sum = values.reduce((a, b) => a + b, 0);

            return {
                avg: (sum / values.length).toFixed(1),
                max: Math.max(...values),
                min: Math.min(...values),
                rate: Math.round((validRecords.length / 7) * 100)
            };
        }

        function getWeeklyComment(stats, weekData) {
            if (stats.avg === null) {
                return 'ğŸ¦• è¨˜éŒ²ã‚’å§‹ã‚ã¦ã€æç«œã¨ä¸€ç·’ã«æŒ¯ã‚Šè¿”ã‚ã†ï¼';
            }

            const avg = parseFloat(stats.avg);
            const nickname = growthData.nickname || 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼';

            if (stats.rate === 100) {
                if (avg >= 8) {
                    return `ğŸ‰ å®Œç’§ï¼${nickname}ã‚‚å¤§å–œã³ã ã‚ˆï¼`;
                } else if (avg >= 5) {
                    return `âœ¨ æ¯æ—¥è¨˜éŒ²ã§ããŸã­ï¼${nickname}ãŒå¿œæ´ã—ã¦ã‚‹ã‚ˆï¼`;
                } else {
                    return `ğŸ’ª æ¯æ—¥ç¶šã‘ãŸå›ã¯ã™ã”ã„ï¼${nickname}ã¨ä¸€ç·’ã«é ‘å¼µã‚ã†ï¼`;
                }
            } else if (stats.rate >= 70) {
                return `ğŸ˜Š ã„ã„èª¿å­ï¼${nickname}ã‚‚å¬‰ã—ãã†ï¼`;
            } else if (stats.rate >= 40) {
                return `ğŸŒ± å°‘ã—ãšã¤ã§OKï¼${nickname}ãŒå¾…ã£ã¦ã‚‹ã‚ˆï¼`;
            } else {
                return `ğŸ¦• ${nickname}ãŒä¼šã„ãŸãŒã£ã¦ã‚‹ã‚ˆï¼`;
            }
        }

        function renderWeeklyChart(weekData) {
            const chartEl = document.getElementById('weeklyChart');
            if (!chartEl) return;

            chartEl.innerHTML = weekData.map(day => {
                const height = day.value ? (day.value / 10) * 60 : 5;
                const barClass = day.value ? 'bar-fill' : 'bar-fill bar-empty';
                const valueText = day.value || '-';
                const labelStyle = day.isToday ? 'font-weight: bold; color: #f59e0b;' : '';

                return `
                    <div class="chart-bar">
                        <span class="bar-value">${valueText}</span>
                        <div class="${barClass}" style="height: ${height}px;"></div>
                        <span class="bar-label" style="${labelStyle}">${day.dayName}</span>
                    </div>
                `;
            }).join('');
        }

        function updateWeeklySummary() {
            const weekData = getLastWeekRecords();
            const stats = calculateWeeklyStats(weekData);

            // çµ±è¨ˆå€¤ã®è¡¨ç¤º
            document.getElementById('weeklyAvg').textContent = stats.avg !== null ? stats.avg : '--';
            document.getElementById('weeklyRate').textContent = stats.rate + '%';
            document.getElementById('weeklyMax').textContent = stats.max !== null ? stats.max : '--';

            // ã‚°ãƒ©ãƒ•æç”»
            renderWeeklyChart(weekData);

            // ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
            document.getElementById('weeklyComment').textContent = getWeeklyComment(stats, weekData);
        }

        // ========== é€±é–“ã‚µãƒãƒªãƒ¼æ©Ÿèƒ½ã“ã“ã¾ã§ ==========


        // åˆæœŸåŒ–
        updateHistory();
        updateCharacterDisplay();
        updateWeeklySummary();
        checkTodayRecord();

        function checkTodayRecord() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = records.find(r => r.date === today);

            if (todayRecord) {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('recordedValue').textContent = todayRecord.value;
                document.getElementById('encouragement').innerHTML =
                    `ä»Šæ—¥ã¯æ—¢ã«è¨˜éŒ²æ¸ˆã¿ã§ã™ã€‚<br><small style="color: #64748b;">ç·¨é›†ã™ã‚‹å ´åˆã¯<a href="history-calendar.html" style="color: #667eea;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚</small>`;
                document.getElementById('result').classList.add('show');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(records, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `health-records-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedRecords = JSON.parse(e.target.result);
                    if (confirm(`${importedRecords.length}ä»¶ã®è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                        records = importedRecords;
                        localStorage.setItem('simpleHealthRecords', JSON.stringify(records));
                        updateHistory();
                        checkTodayRecord();
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼');
                        location.reload();
                    }
                } catch (error) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                }
            };
            reader.readAsText(file);
        }

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ©Ÿèƒ½
        function openNicknameModal() {
            const currentName = growthData.nickname || '';
            document.getElementById('nicknameInput').value = currentName;
            document.getElementById('nicknameModal').style.display = 'flex';
        }

        function closeNicknameModal() {
            document.getElementById('nicknameModal').style.display = 'none';
        }

        function saveNickname() {
            const newName = document.getElementById('nicknameInput').value.trim();
            if (newName) {
                growthData.nickname = newName;
            } else {
                delete growthData.nickname; // ç©ºã®å ´åˆã¯å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’è¡¨ç¤ºï¼‰
            }

            // ä¿å­˜
            localStorage.setItem('growthData', JSON.stringify(growthData));

            // ç”»é¢æ›´æ–°
            updateCharacterDisplay();
            closeNicknameModal();
            alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ğŸ·ï¸');
        }

        function suggestRandomName() {
            const names = [
                'ãƒ¬ãƒƒã‚¯ã‚¹', 'ãƒãƒ', 'ã‚¿ãƒ', 'ã‚­ãƒ³ã‚°', 'ãƒ€ã‚¤ãƒŠ',
                'ã‚¬ãƒ–', 'ãƒ•ã‚¡ãƒ³ã‚°', 'ãƒ¢ã‚³', 'ã‚³ãƒ­', 'ãƒªãƒ¥ã‚¦',
                'ãƒãƒ­ãƒ³', 'ã‚¨ãƒ¼ã‚¹', 'ãƒãƒ§ã‚³', 'ãƒãƒ­ãƒ³', 'ãƒ©ãƒƒã‚­ãƒ¼',
                'ã‚¹ãƒ‘ã‚¤ã‚¯', 'ãƒ­ãƒƒã‚­ãƒ¼', 'ãƒ¬ã‚ª', 'ã‚½ãƒ©', 'ã‚«ã‚¤'
            ];
            const randomName = names[Math.floor(Math.random() * names.length)];
            document.getElementById('nicknameInput').value = randomName;
        }
        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';

            // é–‹ã„ãŸæ™‚ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆ
            const data = {
                version: 1,
                timestamp: Date.now(),
                simpleHealthRecords: JSON.parse(localStorage.getItem('simpleHealthRecords') || '[]'),
                growthData: JSON.parse(localStorage.getItem('growthData') || '{}'),
                encyclopedia: JSON.parse(localStorage.getItem('encyclopedia') || '{}')
            };
            document.getElementById('exportText').value = JSON.stringify(data);
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function exportBackup() {
            const text = document.getElementById('exportText');
            text.select();
            document.execCommand('copy');

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIã‚‚è©¦è¡Œ
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text.value).then(() => {
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nãƒ¡ãƒ¢å¸³ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                }).catch(() => {
                    alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’é¸æŠæ¸ˆã¿ï¼‰');
                });
            } else {
                alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’é¸æŠæ¸ˆã¿ï¼‰');
            }
        }

        function importBackup() {
            const text = document.getElementById('importText').value.trim();
            if (!text) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            try {
                const data = JSON.parse(text);

                // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!data.simpleHealthRecords || !data.growthData) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }

                if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\næœ¬å½“ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }

                localStorage.setItem('simpleHealthRecords', JSON.stringify(data.simpleHealthRecords));
                localStorage.setItem('growthData', JSON.stringify(data.growthData));
                if (data.encyclopedia) {
                    localStorage.setItem('encyclopedia', JSON.stringify(data.encyclopedia));
                }

                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¾ã™ã€‚');
                location.reload();

            } catch (e) {
                alert('ã‚¨ãƒ©ãƒ¼ï¼šãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\n' + e.message);
            }
        }

        // é€šçŸ¥æ©Ÿèƒ½
        function initNotification() {
            updateNotifyButton();
            checkAndNotify();

            // æ¯åˆ†ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•ä¸­ï¼‰
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 7 && now.getMinutes() === 30) {
                    checkAndNotify();
                }
            }, 60000);
        }

        function updateNotifyButton() {
            const btn = document.getElementById('notifyBtn');
            if (Notification.permission === 'granted') {
                btn.textContent = 'é€šçŸ¥ã¯ONã§ã™ âœ…';
                btn.style.background = '#10b981';
            } else if (Notification.permission === 'denied') {
                btn.textContent = 'é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ ğŸš«';
                btn.style.background = '#ef4444';
            } else {
                btn.textContent = 'é€šçŸ¥è¨­å®šã‚’ONã«ã™ã‚‹ ğŸ””';
                btn.style.background = '#8b5cf6';
            }
        }

        function toggleNotification() {
            if (Notification.permission === 'granted') {
                alert('é€šçŸ¥ã¯æ—¢ã«æœ‰åŠ¹ã§ã™ã€‚');
                return;
            }

            Notification.requestPermission().then(permission => {
                updateNotifyButton();
                if (permission === 'granted') {
                    new Notification('é€šçŸ¥ãŒONã«ãªã‚Šã¾ã—ãŸ', {
                        body: 'æ¯æœ7:30ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ãŠå±Šã‘ã—ã¾ã™ï¼ˆã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãŠãã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼‰',
                        icon: 'assets/icons/icon-192.png'
                    });
                }
            });
        }

        function checkAndNotify() {
            if (Notification.permission !== 'granted') return;

            const now = new Date();
            const todayStr = getVirtualDate().toISOString().split('T')[0];

            // ä»Šæ—¥ã®è¨˜éŒ²ãŒã‚ã‚‹ã‹ç¢ºèª
            const hasRecord = records.some(r => r.date === todayStr);

            // 7:30ä»¥é™ã§ã€ã¾ã è¨˜éŒ²ãŒãªã„å ´åˆ
            if (!hasRecord) {
                // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ7:30éãã¦ã„ã‚‹å ´åˆï¼‰
                if (now.getHours() > 7 || (now.getHours() === 7 && now.getMinutes() >= 30)) {
                    // æ—¢ã«ä»Šæ—¥é€šçŸ¥æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€
                    // ç°¡æ˜“çš„ã«ã€Œèµ·å‹•æ™‚ã«1å›å‡ºã™ã€ã“ã¨ã«ã™ã‚‹ï¼ˆã“ã“ã‚’èª¿æ•´å¯èƒ½ï¼‰

                    // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«é€šçŸ¥ç™ºè¡Œ
                    new Notification('ä½“èª¿è¨˜éŒ²ã®æ™‚é–“ã§ã™', {
                        body: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã®ä½“èª¿ã‚’è¨˜éŒ²ã—ã¦ã€æç«œã‚’è‚²ã¦ã¾ã—ã‚‡ã†ğŸ¦•',
                        icon: 'assets/icons/icon-192.png',
                        tag: 'health-reminder-' + todayStr // åŒã˜æ—¥ã®é‡è¤‡é€šçŸ¥ã‚’é˜²ãã‚¿ã‚°
                    });
                }
            }
        }

        // èµ·å‹•æ™‚ã«é€šçŸ¥åˆæœŸåŒ–
        initNotification();
    </script>
</body>

</html>